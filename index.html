<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="abcjs_midi_5.8.1-min.js" type="text/javascript"></script>
  <link href="abcjs-midi.css" media="all" rel="stylesheet" type="text/css">
  <script type="text/javascript">
    if ((host !== "localhost:3000") && (window.location.protocol != 'https:')) {
      window.location.protocol = 'https';
    }
  </script>
  <style>
    .center {
      text-align: center;
    }

    body {
      font-family: sans-serif;
    }

    .title {
      font-size: xx-large;
    }

    .instructions {
      font-size: x-small;
    }

    .pad {
      padding: 5px;
    }

    .round {
      border-radius: 10px;
      padding: 10px;
    }

    .toast {
      display: absolute;
      position: fixed;
      bottom: 10px;
      right: 10px;
      margin-bottom: 5px;
      margin-right: 5px;
    }

    .display-none {
      display: none;
    }

    @-webkit-keyframes quickFlash {
      0% {
        opacity: .8;
      }
      70% {
        opacity: .8;
      }
      100% {
        opacity: 0;
      }
    }

    .quickFlash {
      -webkit-animation-name: quickFlash;
      -webkit-animation-duration: 3000ms;
      -webkit-animation-iteration-count: 1;
      -webkit-animation-timing-function: ease;
      -moz-animation-name: quickFlash;
      -moz-animation-duration: 3000ms;
      -moz-animation-iteration-count: 1;
      -moz-animation-timing-function: ease;
    }

    .goodColor {
      background-color: lime;
    }
    .badColor {
      background-color: gray;
    }
  </style>
</head>
<body class="center">
  <div class="title">Folk Tune Transposer</div>
  <div class="pad">
    <span class="pad">Instrument Key: <select id="instrumentKey" onchange="newKeySelected()"></select></span>
    <span class="pad">Octave: <select id="octaveChange" onchange="newOctaveSelected()"></select></span>
  </div>
  <div class="toast">
    <span id='flash-message' class="round"></span>
  </div>
  <div class="pad instructions">
    <div class="pad">This tool grabs a tune from your clipboard, stores the tune in the URL, and transposes it.</div>
    <div>Find a tune on <a href="https://www.folktunefinder.com">www.folktunefinder.com</a>. Copy its "ABC notation" to your clipboard, then "paste" it here.</div>
  </div>
  <div class="pad">
    <button onclick="renderFromClipboard()">Use tune from clipboard</button>
  </div>
  <div>
    <div id="paper"></div>
    <div id="midi"></div>
  </div>
  <div>
    <button onclick="renderExample()">Try an example tune</button>
  </div>
  <div class="instructions">
    <div>Desktop only. Drag this <a href="https://en.wikipedia.org/wiki/Bookmarklet">bookmarklet</a> to your bookmarks toolbar, and click it while viewing a <a href="https://www.folktunefinder.com">www.FolkTuneFinder.com</a> tune.</div>
    Bookmarklet: <a href='javascript:(function(){window.location = "https://folktunetransposer.com/#" + encodeURIComponent(document.getElementsByTagName("pre")[0].textContent)})();'>Transpose Tune</a>
  </div>
</body>
<script>
function generateTransposeOptions() {
  var transposeMap = {
    "Ab": -4,
    "A": -3,
    "Bb": -2,
    "B": -1,
    "C": 0,
    "C#": 1,
    "D": 2,
    "Eb": 3,
    "E": 4,
    "F": 5,
    "F#": 6,
    "G": -5
  };

  var transposeDropdown = document.getElementById('instrumentKey');
  Object.keys(transposeMap).forEach(key => {
    value = transposeMap[key];
    var option = document.createElement('option')
    option.text = key
    option.value = value
    transposeDropdown.appendChild(option);
  })

  var storedValue = window.localStorage.getItem('instrumentKey')
  if (storedValue) {
    transposeDropdown.value = storedValue;
  } else {
    transposeDropdown.value = 0;
  }
}

function setupOctave() {
  var octaveMap = {
    "+3": 36,
    "+2": 24,
    "+1": 12,
    "same": 0,
    "-1": -12,
    "-2": -24,
    "-3": -36
  }

  var octaveDropdown = document.getElementById('octaveChange');
  Object.keys(octaveMap).forEach(key => {
    value = octaveMap[key];
    var option = document.createElement('option')
    option.text = key
    option.value = value
    octaveDropdown.appendChild(option);
  })

  var storedValue = window.localStorage.getItem('octaveChange')
  if (storedValue) {
    octaveDropdown.value = storedValue;
  } else {
    octaveDropdown.value = 0;
  }
}

function newKeySelected(){
  var transposeDropdown = document.getElementById('instrumentKey');
  window.localStorage.setItem('instrumentKey', transposeDropdown.value);
  renderCurrentTune();
}

function newOctaveSelected(){
  var octaveDropdown = document.getElementById('octaveChange');
  window.localStorage.setItem('octaveChange', octaveDropdown.value);
  renderCurrentTune();
}

function transposeAmount() {
  var instrumentKeyTransposeAmount = parseInt(document.getElementById('instrumentKey').value);
  var octaveChangeTransposeAmount = parseInt(document.getElementById('octaveChange').value);
  return instrumentKeyTransposeAmount + octaveChangeTransposeAmount;
}

function renderCurrentTune() {
  ABCJS.renderAbc('paper', currentTune, {
    visualTranspose: transposeAmount(),
    responsive: "resize"
  });
}

function updateUrlToCurrentTune() {
  window.location.hash = encodeURIComponent(currentTune);
}

function renderFromURL() {
  if (window.location.hash) {
    currentTune = decodeURIComponent(window.location.hash.substr(1));
    renderCurrentTune();
    document.getElementById('flash-message').textContent = "tune read from URL";
    document.getElementById('flash-message').classList.remove('display-none');
    document.getElementById('flash-message').classList.add("quickFlash")
    document.getElementById('flash-message').classList.add("goodColor")
  } else {
    renderFromClipboard();
  }
  setTimeout(function(){
    document.getElementById('flash-message').classList.add('display-none');
  }, 3000);
}

function renderFromClipboard() {
  navigator.clipboard.readText().then((text) => {
    currentTune = text;
    renderCurrentTune()
    updateUrlToCurrentTune();
    document.getElementById('flash-message').textContent = "tune read from clipboard, URL updated";
    document.getElementById('flash-message').classList.remove('display-none');
    document.getElementById('flash-message').classList.add("quickFlash")
    document.getElementById('flash-message').classList.add("goodColor")
  }).catch(() => {
    renderExample()
    document.getElementById('flash-message').textContent = "no tune in clipboard, showing example tune";
    document.getElementById('flash-message').classList.remove('display-none');
    document.getElementById('flash-message').classList.add("quickFlash")
    document.getElementById('flash-message').classList.add("badColor")
  })

  setTimeout(function(){
    document.getElementById('flash-message').classList.add('display-none');
  }, 3000);
}

function renderExample() {
  var exampleTune = `X: 33
T:Old Grey Cat
M:4/4
L:1/8
K:EDor
"Em"e2 e2 E3F|GFGA BABc|"D"d2d2 D3E|FAdB AFED|!
"Em"e2e2 E3F|GFGA BABc|"D"dcBA BAGF|"Em"E4 e2:|!
|:"Em"B2e2 e3d|Bdef gfed|"D"A2d2 d3B|ABde fedf|!
"Em"e2B2 "G"g2B2|"A"a2B2 "B"b4a|gfed BABd|"EM"e4 e4:|!`;

  currentTune = exampleTune

  renderCurrentTune()
}


generateTransposeOptions()
setupOctave()

document.addEventListener("DOMContentLoaded", function(event) {
  // renderFromClipboard();
  renderFromURL();
})


// Google Analytics
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-39558186-1', 'auto');
  ga('send', 'pageview');


</script>
</html>
