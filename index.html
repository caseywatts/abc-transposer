<html>
<head>
  <script src="abcjs_midi_5.8.1-min.js" type="text/javascript"></script>
  <link href="abcjs-midi.css" media="all" rel="stylesheet" type="text/css">
  <script type="text/javascript">
    var host = 'caseywatts.com';
    if ((host == window.location.host) && (window.location.protocol != 'https:')) {
      window.location.protocol = 'https';
    }
  </script>
  <style>
    .center {
      text-align: center;
    }

    .pad {
      padding: 5px;
    }

    .round {
      border-radius: 10px;
      padding: 10px;
    }

    @-webkit-keyframes quickFlash {
      0%, 100% {
        background-color: none;
        /* opacity: 1; */
      }
      50% {
        background-color: lime
      }
    }

    .quickFlash {
      -webkit-animation-name: quickFlash;
      -webkit-animation-duration: 1000ms;
      -webkit-animation-iteration-count: 1;
      -webkit-animation-timing-function: ease;
      -moz-animation-name: quickFlash;
      -moz-animation-duration: 1000ms;
      -moz-animation-iteration-count: 1;
      -moz-animation-timing-function: ease;
    }
  </style>
</head>
<body class="center">
  <div class="pad">
    Instrument Key: <select id="instrumentKey" onchange="newKeySelected()"></select>
  </div>
  <div class="pad">
    <span id='read-from-clipboard' class="round"></span>
  </div>
  <div>
    <div id="paper"></div>
    <div id="midi"></div>
  </div>
  <div class="pad">
    <button onclick="renderFromClipboard()">re-read abc from clipboard</button>
    <button onclick="renderExample()">display example</button>
  </div>
</body>
<script>
function generateTransposeOptions() {
  var transposeMap = {
    "C": 0,
    "Bb": -2,
    "Bb (up)": 10,
    "F": 5,
    "F (down)": -7
  };

  var transposeDropdown = document.getElementById('instrumentKey');
  Object.keys(transposeMap).forEach(key => {
    value = transposeMap[key];
    var option = document.createElement('option')
    option.text = key
    option.value = value
    transposeDropdown.appendChild(option);
  })

  var storedValue = window.localStorage.getItem('instrumentKey')
  if (storedValue) {
    transposeDropdown.value = storedValue
  }
}

function newKeySelected(){
  var transposeDropdown = document.getElementById('instrumentKey');
  window.localStorage.setItem('instrumentKey', transposeDropdown.value);
  console.log(transposeDropdown.value)
  renderCurrentTune();
}

function transposeAmount() {
  return document.getElementById('instrumentKey').value;
}

function renderCurrentTune() {
  ABCJS.renderAbc('paper', currentTune, {visualTranspose: transposeAmount()});
}

function renderFromClipboard() {
  navigator.clipboard.readText().then((text) => {
    currentTune = text;
    renderCurrentTune()
    document.getElementById('read-from-clipboard').textContent = "automatically reading in abc notation from the clipboard";
    document.getElementById('read-from-clipboard').classList.add("quickFlash")
  })
}

function renderExample() {
  var exampleTune = `X: 33
T:Old Grey Cat
M:4/4
L:1/8
K:EDor
"Em"e2 e2 E3F|GFGA BABc|"D"d2d2 D3E|FAdB AFED|!
"Em"e2e2 E3F|GFGA BABc|"D"dcBA BAGF|"Em"E4 e2:|!
|:"Em"B2e2 e3d|Bdef gfed|"D"A2d2 d3B|ABde fedf|!
"Em"e2B2 "G"g2B2|"A"a2B2 "B"b4a|gfed BABd|"EM"e4 e4:|!`;

  currentTune = exampleTune

  renderCurrentTune()
}

generateTransposeOptions()
document.addEventListener("DOMContentLoaded", function(event) {
  renderFromClipboard();
})

</script>
</html>
